pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                git url: 'https://github.com/salibouaziz/verificationTool.git'
            }
        }
         stage('SonarQube Analysis') {
            steps {
                script {
                    // Run SonarQube analysis using the SonarQube scanner (Windows version)
                    bat '''
                    sonar-scanner ^
                        -Dsonar.projectKey=test ^  
                        -Dsonar.sources=. ^
                        -Dsonar.host.url=http://localhost:9000 ^
                        -Dsonar.login=squ_fdc55c92864dfa526b22fe2bdda1c713489dcac5  
                    '''
                }
            }
        }
        stage('Build Docker image') {
            steps {
                script {
                    bat 'docker build -t salibou/verification-tool:latest .'
                }
            }
        }

        stage('Run Docker Container with Mounted Volumes') {
            steps {
                script {
                    def indexPath = "C:\\Users\\sally\\OneDrive\\Bureau\\index.txt"
                    def packagePath = "C:\\Users\\sally\\OneDrive\\Bureau\\A591-09626-0100000_08415_ELV_00412_No_OS\\A591-09626-0100000"
                    
                    bat """
                    docker run ^
                    -v ${indexPath}:/app/index.txt ^
                    -v ${packagePath}:/app/package ^
                    salibou/verification-tool:latest
                    """
                }
            }
        }

        stage('Push Docker Image') {
            steps {
               script {
                    // Use withCredentials to pass the Docker Hub credentials
                    withCredentials([string(credentialsId: 'dockerhub', variable: 'dockerhub')]) {
                        // Use the correct syntax for environment variables in Windows batch script
                        bat 'docker login -u bouaziz.sali@enis.tn -p %dockerhub%'
                    }
                    // Push the Docker image
                    bat 'docker push salibou/verification-tool:latest'
                }
            }
        }

        stage('Post Build Actions') {
            steps {
                echo 'Build, run with mounted  '
            }
        }
    }
}
